@startuml
skinparam style strictuml
skinparam SequenceBoxBorderColor white
skinparam sequenceBoxBackgroundColor ivory

box "Motech"
participant "Motech Events" as ME
participant "ICAPPR" as ICAP
participant "IVR-Verboice" as IVR
end box
participant "Verboice" as V
participant "Patient" as P

ME ->> ICAP : PILL_REMINDER_CALL
activate ICAP

ICAP -> IVR : initiateCall()
activate IVR

IVR -> V : HTTP call
activate V
IVR <<-- V : call Id
deactivate IVR
deactivate ICAP

V ->> P : ring phone (SIP, etc.)

V -> IVR : HTTP status "ringing"
activate IVR
V <<-- IVR : next status URL
deactivate IVR

V <<-- P : answer phone
activate P

V -> IVR : HTTP status "in-progress"
activate IVR
V <<-- IVR : next status URL
deactivate IVR

V -> P : play Motech music
V <<-- P : enter pin
V -> ICAP : HTTP authenticate
activate ICAP
V <<-- ICAP : result=true
deactivate ICAP

V -> P : play "concern?"
V <<-- P : answer "no"
V -> ICAP : HTTP patientConcern
activate ICAP
ICAP ->> ME : NO_ADHERENCE_CONCERNS
deactivate ICAP
V -> P : play "goodbye"
P -> P : hang up
deactivate P

V -> V : hang up

V -> IVR : HTTP status "completed"
activate IVR
V <<-- IVR : next status URL
deactivate IVR
V -> IVR : HTTP status "Disconnect"
activate IVR
V <<-- IVR : next status URL
deactivate IVR
deactivate V

@enduml
