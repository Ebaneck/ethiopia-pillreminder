@startuml
skinparam style strictuml
skinparam SequenceBoxBorderColor white

box "ICAPPR" #ghostwhite
participant CallInitiationService
participant PinAuthenticationController
participant VerboiceInteractionController
end box

box "Motech" #ivory
participant "IVR Service" as IVR
end box

participant "Verboice" as V
participant "Patient" as P

box "Motech" #ivory
participant "Platform Events" as Events
end box

CallInitiationService -> IVR : initiateCall()
activate IVR

IVR -> V : HTTP call
activate V
IVR <<-- V : call Id
deactivate IVR

V ->> P : ring phone (SIP, etc.)

V -> IVR : HTTP status "ringing"
activate IVR
V <<-- IVR : next status URL
deactivate IVR

V <<- P : answer phone
activate P

V -> IVR : HTTP status "in-progress"
activate IVR
V <<-- IVR : next status URL
deactivate IVR

V -> P : play Motech music
V <<-- P : enter pin
V -> PinAuthenticationController : HTTP authenticate
activate PinAuthenticationController
V <<-- PinAuthenticationController : result=true
deactivate PinAuthenticationController

V -> P : play "yellow skin?"
V <<-- P : answer "yes"
V -> VerboiceInteractionController : HTTP patientConcern
activate VerboiceInteractionController
VerboiceInteractionController ->> Events : YES_YELLOW_SKIN_OR_EYES
deactivate VerboiceInteractionController
note right of Events : to response\nrecording
V -> P : play "goodbye"
P -> P : hang up
deactivate P

V -> V : hang up

V -> IVR : HTTP status "completed"
activate IVR
V <<-- IVR : next status URL
deactivate IVR
V -> IVR : HTTP status "Disconnect"
activate IVR
V <<-- IVR : next status URL
deactivate V

IVR ->> Events : END_OF_CALL_EVENT
deactivate IVR

@enduml
